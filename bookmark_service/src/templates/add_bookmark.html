<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Bookmark</title>
</head>
<body>
    <h1>Add Bookmark</h1>
    <form id="addBookmarkForm">
        <label for="group_name">Group Name:</label>
        <select id="group_name" name="group_name">
            <option value="" selected disabled>Select or enter a group</option>
            <!-- 初始加载时的书签组数据 -->
            {% for group in groups %}
            <option value="{{ group }}">{{ group }}</option>
            {% endfor %}
        </select>
        <input type="text" id="new_group_name" name="new_group_name" placeholder="Enter new group">
        <br>
        <label for="service_name">Bookmark Name:</label>
        <input type="text" id="service_name" name="service_name" required><br>
        <label for="abbr">Abbreviation:</label>
        <input type="text" id="abbr" name="abbr"><br>
        <label for="url">URL:</label>
        <input type="text" id="url" name="url" required><br>
        <input type="submit" value="Add Bookmark">
    </form>
    <script>
        // 获取下拉菜单元素
        const groupSelect = document.getElementById('group_name');
        
        // 监听下拉菜单的点击事件
        groupSelect.addEventListener('focus', fetchGroups);
        
        // 监听下拉菜单的展开事件（兼容不同浏览器）
        groupSelect.addEventListener('click', function() {
            if (this.size === 1) {
                fetchGroups();
            }
        });
        
        // 从服务器获取最新的书签组数据
        function fetchGroups() {
            fetch('/api/bookmarks')
                .then(response => response.json())
                .then(data => {
                    // 清空现有选项（保留第一个提示选项）
                    const firstOption = groupSelect.options[0];
                    groupSelect.innerHTML = '';
                    groupSelect.appendChild(firstOption);
                    
                    // 添加从服务器获取的最新书签组
                    const groups = extractGroupNames(data);
                    groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group;
                        option.textContent = group;
                        groupSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching groups:', error);
                    alert('Failed to load groups. Please try again.');
                });
        }
        
        // 从API响应中提取书签组名称
        function extractGroupNames(data) {
            const groups = [];
            data.forEach(group => {
                const groupName = Object.keys(group)[0];
                groups.push(groupName);
            });
            return groups;
        }
        
        // 处理表单提交
        document.getElementById('addBookmarkForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const groupName = document.getElementById('group_name').value || document.getElementById('new_group_name').value;
            const serviceName = document.getElementById('service_name').value;
            const abbr = document.getElementById('abbr').value;
            const url = document.getElementById('url').value;
            
            if (!groupName) {
                alert('Please select or enter a group name');
                return;
            }
            
            const data = {
                group_name: groupName,
                service_name: serviceName,
                abbr: abbr,
                url: url
            };
            
            fetch('/api/bookmarks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                alert(result.message);
                if (result.message === 'Bookmark added successfully') {
                    window.location.reload();
                }
            });
        });
    </script>
</body>
</html>